================================================================================
PLANT BUILDER DESCRIPTOR FILE USER GUIDE
================================================================================

OVERVIEW
--------
The Plant Builder uses YAML format descriptor files to define construction
workflows. These files specify what objects to build, their parameters, and
the sequence of operations.

The YAML format is human-readable and supports:
- Comments (using #)
- Hierarchical structure with indentation
- Lists and dictionaries
- Multiple data types (strings, numbers, booleans)
- File includes and parameter substitution

FILE STRUCTURE
--------------
Each descriptor file contains several main sections:

1. include          - Files to include and merge (optional)
2. params           - Parameter definitions for ${var} substitution (optional)
3. metadata         - Project information (optional)
4. global_settings  - Settings that apply to all operations
5. output_files     - File paths for generated reports
6. workflow         - Main sequence of operations to perform

SECTION DETAILS
===============

1. INCLUDE AND PARAMETER SUBSTITUTION
--------------------------------------
Files can include other YAML files and define reusable parameters.

Include files:
  include:
    - base/defaults.yml          # Relative to yaml_files/base/
    - ../shared/common.yml       # Relative to config file directory
    - /absolute/path/file.yml    # Absolute path

Included files are deep-merged: dicts merge recursively, scalars and lists
replace. Includes are processed first, so the including file's values
override included defaults. Circular includes are detected and rejected.

Parameter substitution:
  params:
    out_dir: /home/user/output
    cylinder_diameter: 2.25
    project_name: My Project

  output_files:
    working_directory: ${out_dir}     # Substituted at load time

  wafer_settings:
    cylinder_diameter: ${cylinder_diameter}   # Type preserved (float)

Rules:
- If ${param} is the entire value, the original type is preserved (float,
  int, bool)
- If ${param} is embedded in a larger string, it is coerced to string
- ${ENV:VAR_NAME} accesses environment variables
- Undefined parameters raise an error

2. METADATA SECTION
-------------------
Project information written to FreeCAD document properties and a visible
ModelMetadata object.

  metadata:
    project_name: "Helical Test Structure"
    version: "1.0"
    created: "2025-01-25"
    description: "Test project demonstrating helical curve following"

Standard keys: project_name, version, description, created.
Any additional keys are written to doc.Meta as string key-value pairs.
The system auto-adds Generator, MetadataApplied, and SourceConfig.

3. GLOBAL SETTINGS
------------------
Settings that affect the entire build process:

  global_settings:
    workflow_mode: null             # null | "first_pass" | "second_pass"
    remove_existing: true           # Remove existing objects before building
    relocate_segments: true         # Position segments end-to-end
    print_cuts: true                # Generate cutting instruction file
    print_place: true               # Generate placement coordinate file
    show_lcs: false                 # Show local coordinate systems
    temp_file: "temp_construction.dat"
    include_cut_list_definitions: false  # Append column definitions to cut list

Workflow modes:
  null (or omitted) - Single run: executes all operations normally
  "first_pass"      - Generates segments; close_curve/close_loop creates
                      an editable BSpline curve and stops for manual editing
  "second_pass"     - Skips all operations except close_curve/close_loop;
                      reconstructs segments from existing document objects;
                      uses the edited curve from first_pass

4. OUTPUT FILES
---------------
Specify paths for generated files:

  output_files:
    working_directory: "/home/user/output/"
    cuts_file: "cutting_list.txt"       # Cutting instructions
    place_file: "placement_list.txt"    # Wafer placement coordinates
    trace_file: "build_trace.log"       # Build process log
    show_lcs_in_cutlist: false          # Include LCS data in cut list

5. WORKFLOW OPERATIONS
======================

REMOVE OBJECTS
--------------
Remove existing FreeCAD objects, keeping those that match patterns.
ModelMetadata is always preserved automatically.

  - operation: "remove_objects"
    description: "Clean up any existing objects"
    keep_patterns:
      - "helix.*"                   # Substring/prefix/suffix match
      - ".*Metadata.*"

Pattern matching supports:
- Exact match: "MyObject"
- Prefix match: "Curve*"       (pattern ends with *)
- Suffix match: "*_Part"       (pattern starts with *)
- Substring match: "helix"     (contained anywhere in label or name)

Matched objects and all their children (Group members, OutList) are kept.

SET POSITION
------------
Set the starting position and orientation for the first segment:

  - operation: "set_position"
    description: "Set starting position and orientation"
    position: [0, 0, 0]          # x, y, z coordinates
    rotation: [0, 0, 0]          # yaw, pitch, roll in degrees (optional)

If rotation is omitted, defaults to [0, 0, 0].

BUILD SEGMENT
-------------
Build a segment that follows a mathematical curve:

  - operation: "build_segment"
    segment_type: "curve_follower"
    name: "segment_name"
    description: "Optional description"

    curve_spec:
      type: "curve_type"          # See curve types below
      parameters:                 # Curve-specific parameters
        # ... varies by curve type
      transformations:            # Optional, applied in order
        - operation: "scale"
          factor: 1.5
        - operation: "rotate"
          axis: "z"
          angle: 45
      segment:                    # Optional curve portion selection
        start_fraction: 0.0       # 0.0 = curve start
        end_fraction: 1.0         # 1.0 = curve end

    connection:                   # Optional, for joining to previous segment
      rotation_angle: 0           # Z-axis rotation at junction (degrees)

    wafer_settings:
      cylinder_diameter: 2.0
      min_height: 1.0
      max_chord: 0.5
      max_wafer_count: null       # Optional hard cap on wafer count
      profile_density: 0.89       # Loft profiles per unit spine length

    segment_settings:
      show_lcs: true              # Show coordinate systems in FreeCAD
      show_loft: false            # Show the reference loft surface
      build_segment: true         # Build the segment geometry
      rotate_segment: 0.0         # Post-build rotation (degrees)
      add_curve_vertices: false   # Add visual points along curve path

CLOSE CURVE
-----------
Close an open multi-segment curve by generating a tangent-constrained
B-spline that bridges the gap between the last segment's exit and the
first segment's entry. All segments plus the closing B-spline are
combined into a single periodic (closed) composite curve, and wafers
are built on it â€” triggering the automatic is_closed gap-closing logic.

  - operation: "close_curve"
    name: "ClosedResult"          # Label for composite curve + wafer segment
    max_closing_angle: 90         # Max turning angle (degrees); abort if exceeded
    points: 50                    # Sampling density for closing B-spline
    num_lcs_per_end: 3            # Wafers to average for tangent direction
    sampling:
      per_segment: 100            # Points per segment for composite curve
    wafer_settings:
      cylinder_diameter: 2.25
      min_height: 1.0
      max_chord: 2.5
    segment_settings:
      show_lcs: false
      build_segment: true

How it works:
  1. Extracts the exit point (last wafer's lcs2) and entry point (first
     wafer's lcs1) in world coordinates.
  2. Computes exit/entry tangent directions by averaging positions from
     the last/first few wafers (controlled by num_lcs_per_end).
  3. Checks that neither turning angle (exit tangent vs gap direction,
     entry tangent vs gap direction) exceeds max_closing_angle. If it
     does, logs an error with the measured angles and positions, and
     returns without generating anything.
  4. Generates a B-spline closing curve with tangent constraints at both
     endpoints for smooth curvature continuity.
  5. Combines all segment curves + closing B-spline into a single
     periodic BSpline (smooth tangent wrap-around at the junction).
  6. Builds wafers on the composite closed curve using the existing_curve
     pipeline, which detects the closed curve and closes the last wafer
     gap automatically.

The "close_loop" operation name is accepted as an alias for backward
compatibility.

EXPORT CURVE
------------
Export a composite curve from multiple existing segments as a single
FreeCAD BSpline object:

  - operation: "export_curve"
    name: "FinalCurve"            # Label for the exported curve
    description: "Composite curve"
    segments:                     # Ordered list of segment names
      - base
      - Curve Left
      - Curve Right
    sampling:
      per_segment: 100            # Points per segment (must be >= 2)

The exported curve joins segment points in world coordinates, removing
duplicate points at junctions. Creates a Part::Feature with a green
BSpline curve.

AVAILABLE CURVE TYPES
=====================

1. LINEAR
---------
Creates a straight line:

  type: "linear"
  parameters:
    length: 100.0              # Length of the line
    points: 100                # Number of points along line
    direction: [0, 0, 1]       # Direction vector [x, y, z]

2. HELICAL
----------
Creates a helix (corkscrew shape):

  type: "helical"
  parameters:
    radius: 10.0               # Radius of the helix
    pitch: 2.5                 # Vertical distance per complete turn
    turns: 4.0                 # Number of complete turns
    points: 100                # Number of points along helix
    start_at_origin: true      # Translate to start at origin

3. SINUSOIDAL
-------------
Creates a sine wave curve:

  type: "sinusoidal"
  parameters:
    length: 50.0               # Length along primary axis
    amplitude: 5.0             # Height of the wave peaks
    frequency: 2.0             # Number of complete wave cycles
    points: 100                # Number of points
    axis: "x"                  # Primary axis: "x", "y", or "z"

4. OVERHAND KNOT
----------------
Creates a mathematical overhand knot:

  type: "overhand_knot"
  parameters:
    scale: 1.0                 # Overall size of the knot
    points: 100                # Number of points (more = smoother)
    increment: 1.0             # Angular increment in degrees

5. CIRCLE
---------
Creates a circular curve:

  type: "circle"
  parameters:
    radius: 10.0               # Radius of the circle
    points: 100                # Number of points around circle
    plane: "xy"                # Plane: "xy", "xz", or "yz"

6. SPIRAL
---------
Creates a spiral with variable radius:

  type: "spiral"
  parameters:
    max_radius: 10.0           # Outer radius
    min_radius: 5.0            # Inner radius
    max_height: 10.0           # Total Z-height
    turns: 2.0                 # Number of complete turns
    points: 100                # Number of points
    plane: "xy"                # Plane: "xy", "xz", or "yz"

7. FIGURE EIGHT
---------------
Creates a figure-eight (lemniscate) shape:

  type: "figure_eight"
  parameters:
    radius: 10.0               # Size of the lobes
    points: 100                # Number of points
    plane: "xy"                # Plane: "xy", "xz", or "yz"

8. TREFOIL
----------
Creates a trefoil knot (torus knot):

  type: "trefoil"
  parameters:
    major_radius: 6.0          # Radius of the main torus path
    tube_radius: 2.0           # Radius of the tube wrapping the torus
    p: 2                       # Longitudinal wraps (2 for trefoil)
    q: 3                       # Meridional wraps (3 for trefoil)
    points: 150                # Number of slices (capped at 200)
    center: [0, 0, 0]          # Center position [x, y, z]
    phase_deg: 0.0             # Starting rotation in degrees
    scale_z: 1.0               # Vertical scaling (< 1 flattens, > 1 stretches)
    jitter: 0.0                # Random perturbation (0.0 - 1.0)
    smooth_factor: 0.5         # Curve smoothing (< 1 = gentler curves)
    optimize_spacing: true     # Redistribute for uniform point spacing

The (p, q) pair defines the knot type: (2,3) = trefoil, (3,5) = cinquefoil.

9. EXISTING CURVE
-----------------
Sample points from an existing FreeCAD curve object in the document:

  type: "existing_curve"
  from_label: "Spine_Curve_Left"  # Label of existing curve object
  num_samples: 100                # Number of sample points (>= 2)

Note: from_label and num_samples are direct keys under curve_spec,
not nested under parameters.

10. CUSTOM
----------
Use a custom Python function (not configurable via YAML alone):

  type: "custom"
  parameters:
    # Whatever parameters your function needs
  custom_function: my_curve_function

The custom function must return a list of [x, y, z] coordinate lists.


CURVE TRANSFORMATIONS
=====================

Transformations are applied to curves in the order listed, after curve
generation and segment selection.

1. SCALE
--------
Resize the curve uniformly or per-axis:

Uniform:
  - operation: "scale"
    factor: 2.0                # All axes scaled equally

Per-axis:
  - operation: "scale"
    factors: [2.0, 1.5, 1.0]  # Scale x by 2.0, y by 1.5, z unchanged

2. ROTATE
---------
Rotate the curve around an axis:

  - operation: "rotate"
    axis: "z"                  # "x", "y", or "z"
    angle: 45                  # Degrees (positive = counterclockwise)

3. TRANSLATE
------------
Move the curve:

  - operation: "translate"
    offset: [10, 0, 5]        # [x, y, z] units

4. MIRROR
---------
Mirror the curve across a plane:

  - operation: "mirror"
    plane: "xy"                # "xy", "xz", or "yz"


CURVE SEGMENT SELECTION
=======================

Use only part of a generated curve:

  segment:
    start_fraction: 0.2        # Start at 20% along the curve
    end_fraction: 0.8          # End at 80% along the curve

Fractions range from 0.0 (curve start) to 1.0 (curve end).


WAFER SETTINGS REFERENCE
=========================

  cylinder_diameter: 2.0       # Diameter of cylinder stock
  min_height: 1.0              # Minimum wafer thickness
  max_chord: 0.5               # Max chord deviation (smaller = more wafers)
  max_wafer_count: null         # Hard cap on wafers per segment (optional)
  profile_density: 0.89         # Loft profiles per unit of spine length

Wafer presets (defined in base/wafer_presets.yml):

  fine:      min_height: 0.08, max_chord: 0.06, max_wafer_count: 120
  standard:  min_height: 0.1,  max_chord: 0.1,  max_wafer_count: 60
  coarse:    min_height: 0.2,  max_chord: 0.2,  max_wafer_count: 30


TIPS AND BEST PRACTICES
========================

1. START SIMPLE
   Begin with basic curves (linear, circle) before attempting
   complex shapes (knots, custom curves).

2. USE INCLUDES AND PARAMS
   Put common settings in a base file and include it:
     include:
       - base/defaults.yml
     params:
       cylinder_diameter: 2.25

3. USE COMMENTS
   Add comments with # to document your choices:
   # This creates the main structural helix
   - operation: "build_segment"

4. TEST INCREMENTALLY
   Build one segment at a time, verify it looks correct, then
   add the next segment.

5. PARAMETER RELATIONSHIPS
   - More points = smoother curves but slower processing
   - Smaller max_chord = more accurate but more wafers
   - Larger min_height = fewer wafers but less curve accuracy
   - Higher profile_density = smoother loft surfaces

6. COORDINATE SYSTEM
   - X: typically left/right
   - Y: typically front/back
   - Z: typically up/down
   - Rotations follow right-hand rule

7. UNITS
   All measurements are in FreeCAD model units (typically millimeters).

8. VISUALIZATION
   Set add_curve_vertices: true to see the curve path.
   Set show_lcs: true to see coordinate systems at wafer boundaries.
   Set show_loft: true to see the reference loft surface.


TROUBLESHOOTING
===============

Common Issues:

"No feasible solution exists"
  - Reduce max_chord value
  - Increase min_height value
  - Check curve has reasonable curvature for cylinder diameter

"Wafer creation failed"
  - Check cylinder_diameter is positive
  - Verify curve has enough points
  - Ensure curve doesn't have duplicate points

"Transform failed"
  - Check transformation parameters are valid
  - Verify axis names are "x", "y", or "z"
  - Ensure rotation angles are reasonable

"Could not find segment named ..."
  - Verify segment names in export_curve match build_segment names exactly
  - Segment names are case-sensitive

File Format Errors:
  - Check YAML indentation (use spaces, not tabs)
  - Verify all brackets and quotes are properly closed
  - Use a YAML validator online to check syntax
  - Check ${param} references match keys in params section


EXAMPLE COMPLETE FILE
=====================

include:
  - base/defaults.yml

params:
  out_dir: /home/user/output
  cylinder_diameter: 2.25
  project_name: Example Build

metadata:
  project_name: ${project_name}
  version: "1.0"
  created: "2025-07-27"
  description: "Example with two segments and loop closure"

output_files:
  working_directory: ${out_dir}
  cuts_file: "cutting_list.txt"

global_settings:
  print_cuts: true
  workflow_mode: null

workflow:
  - operation: remove_objects
    description: Clean up existing objects

  - operation: build_segment
    segment_type: curve_follower
    name: base
    description: Vertical base column
    curve_spec:
      type: linear
      parameters:
        length: 5.0
        points: 10
    wafer_settings:
      cylinder_diameter: ${cylinder_diameter}
      min_height: 1.0
      max_chord: 0.3
    segment_settings:
      show_lcs: true
      build_segment: true

  - operation: build_segment
    segment_type: curve_follower
    name: Curve Left
    description: Quarter circle turn
    curve_spec:
      type: circle
      parameters:
        radius: 8.0
        points: 100
      segment:
        start_fraction: 0.0
        end_fraction: 0.25
    connection:
      rotation_angle: 180
    wafer_settings:
      cylinder_diameter: ${cylinder_diameter}
      min_height: 0.5
      max_chord: 0.1
    segment_settings:
      show_lcs: true
      build_segment: true

  - operation: export_curve
    name: CompositeCurve
    segments: [base, Curve Left]
    sampling:
      per_segment: 100

  - operation: close_curve
    name: ClosedShape
    description: Close the multi-segment curve
    max_closing_angle: 90
    points: 50
    num_lcs_per_end: 3
    sampling:
      per_segment: 100
    wafer_settings:
      cylinder_diameter: ${cylinder_diameter}
      min_height: 1.0
      max_chord: 2.5
    segment_settings:
      show_lcs: false


================================================================================
END OF USER GUIDE
================================================================================
